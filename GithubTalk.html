<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>GithubTalk+</title><style>
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
:root{--bg:#0a0f18;--glass:rgba(16,24,38,.75);--brd:rgba(255,255,255,.08);--txt:#e7ecf2;--mut:#9ab0c6;--acc:#6aa4ff;--bub:#172133}
[data-theme=light]{--bg:#eef3fb;--glass:rgba(255,255,255,.85);--brd:rgba(0,0,0,.08);--txt:#0b1728;--mut:#516a84;--acc:#3a86ff;--bub:#fff}
body{background:radial-gradient(1200px 800px at 10% -10%,#0f1830 0,transparent 60%),radial-gradient(1000px 800px at 110% 20%,#161a2e 0,transparent 60%),linear-gradient(180deg,#0a0f18,#070a0f)}
[data-theme=light] body{background:var(--bg)}
.wrap{max-width:980px;margin:0 auto;padding:12px 16px}
header{position:sticky;top:0;z-index:9;background:linear-gradient(180deg,rgba(10,16,25,.8),rgba(10,16,25,.55));backdrop-filter:saturate(140%) blur(12px);border-bottom:1px solid var(--brd)}
[data-theme=light] header{background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.7))}
h1{margin:0;font-size:18px}
.btn{padding:8px 12px;border-radius:999px;border:1px solid var(--brd);background:var(--glass);color:var(--txt);cursor:pointer}
.btn.p{background:linear-gradient(180deg, color-mix(in oklch,var(--acc),black 60%), color-mix(in oklch,var(--acc),black 40%));border-color:color-mix(in oklch,var(--acc),black 35%)}
.chip{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:var(--glass);border:1px solid var(--brd);color:var(--mut);font-size:12px}
main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
.card{background:var(--glass);border:1px solid var(--brd);border-radius:16px;padding:16px;backdrop-filter:blur(16px)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:1.1fr 1fr 1fr;gap:10px}
input,textarea,select,button{font:inherit;color:var(--txt)}
input,textarea,select{width:100%;padding:11px;border-radius:12px;border:1px solid var(--brd);background:rgba(8,12,18,.7)}
[data-theme=light] input,[data-theme=light] textarea,[data-theme=light] select{background:rgba(255,255,255,.85)}
small{color:var(--mut)}
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:6px 10px;border-radius:999px;border:1px solid var(--brd);background:var(--glass);color:var(--mut);cursor:pointer}
.tab.a{color:var(--txt);border-color:color-mix(in oklch,var(--acc),black 35%)}
.hide{display:none}
#msgs{height:56vh;min-height:360px;overflow:auto;border:1px solid var(--brd);border-radius:14px;padding:8px;background:rgba(8,12,18,.5)}
[data-theme=light] #msgs{background:rgba(255,255,255,.7)}
ul{margin:0;padding:0;list-style:none}
li{display:grid;grid-template-columns:40px 1fr;gap:8px;padding:8px;border-bottom:1px dashed var(--brd)}
.meta{font-size:11px;color:var(--mut);display:flex;gap:8px;align-items:center}
.txt{background:var(--bub);border:1px solid var(--brd);border-radius:12px;padding:8px;word-wrap:anywhere;white-space:pre-wrap}
.ava{width:34px;height:34px;border-radius:999px;border:1px solid var(--brd);object-fit:cover;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(0,0,0,.15))}
.gif{max-width:260px;border:1px solid var(--brd);border-radius:10px}
.send{display:grid;grid-template-columns:40px 40px 1fr 120px;gap:8px;margin-top:8px}
.icon{display:inline-flex;align-items:center;justify-content:center;height:40px;width:40px;border:1px solid var(--brd);border-radius:10px;background:var(--glass)}
.menu{position:fixed;inset:auto auto 0 0;display:none;z-index:20;background:var(--glass);border:1px solid var(--brd);border-radius:10px;min-width:160px}
.menu button{display:block;width:100%;text-align:left;border:0;background:transparent;padding:8px 10px;border-bottom:1px solid var(--brd)}
.menu button:last-child{border:0}
.bad{color:#ffb86b}
#emoji{position:absolute;bottom:110px;left:16px;background:var(--glass);border:1px solid var(--brd);border-radius:12px;padding:6px;display:none;width:260px}
#emoji .g{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;max-height:220px;overflow:auto}
#gifp{position:fixed;inset:auto 0 0 0;background:linear-gradient(180deg,rgba(10,16,25,.1),rgba(10,16,25,.85));backdrop-filter:blur(14px);border-top:1px solid var(--brd);padding:10px;display:none;z-index:15}
#gifr{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px;max-height:42vh;overflow:auto}
#gifr img{width:100%;height:120px;object-fit:cover;border-radius:10px;border:1px solid var(--brd);cursor:pointer}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:25}
.modal .p{width:min(720px,92vw);background:var(--glass);border:1px solid var(--brd);border-radius:16px;padding:16px}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.h{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.note{font-size:12px;color:var(--mut)}
.bell{position:relative}
.badge{position:absolute;top:-6px;right:-6px;background:#f33;color:#fff;border-radius:999px;font-size:10px;padding:1px 5px}
</style></head><body>
<header><div class=wrap style="display:flex;justify-content:space-between;align-items:center;gap:8px">
<div class=h><h1>GithubTalk+</h1><button id=pub class=btn>Public</button><button id=rand class=btn>Random</button><button id=people class=btn>People</button><button id=sett class=btn>Settings</button></div>
<div class=h><button id=share class=btn hide>Copy</button><button id=qr class=btn hide>QR</button><button id=call class=btn hide>Call</button><button id=leave class=btn hide>Leave</button><span id=roomtag class=chip hide></span><span id=metag class=chip hide></span><span id=numtag class=chip hide></span><button id=ibox class="btn bell">Inbox<span id=icount class=badge style="display:none">0</span></button></div>
</div></header>
<main>
<section id=join class=card>
<div class=tabs><div id=tJoin class="tab a">Join</div><div id=tCreate class=tab>Create</div><div id=tPub class=tab>Public</div><div id=tDM class=tab>Private</div></div>
<div id=pJoin>
<div class=row><div><small>Invite</small><input id=invite placeholder="?r=ROOM#k=KEY"></div><div><button id=go class="btn p">Join</button><div id=warn class=note></div></div></div>
<div style="margin-top:8px"><small>Recent</small><div id=recent class=h style="margin-top:6px"></div></div>
</div>
<div id=pCreate class=hide>
<div class=grid3><div><small>Group</small><input id=room placeholder="auto"></div><div><small>Name</small><input id=nick placeholder="you will be asked if blank"></div><div><small>Passphrase</small><input id=pass placeholder="auto"></div></div>
<div class=h style="margin-top:8px"><button id=mk class="btn p">Create group</button><small>Long passphrase recommended</small></div>
</div>
<div id=pPub class=hide><small>Public lobbies</small><div id=pubs class=h style="margin-top:6px"></div></div>
<div id=pDM class=hide><div class=row><div><small>Start DM with Number</small><input id=dmNum placeholder="N..."></div><div style="align-self:end"><button id=dmStart class="btn p">Start</button></div></div><small>Share your Number in People → My Number</small></div>
</section>
<section id=chat class="card hide">
<div class=row><div id=stat class=note></div><div style=text-align:right><small class=note>Be careful with links</small></div></div>
<div id=msgs></div>
<div id=emoji><div class=g id=eg></div></div>
<div id=gifp><div class=row><div><input id=gq placeholder="Search GIPHY"></div><div class=h><button id=gx class=btn>Close</button><button id=gk class=btn>API Key</button></div></div><div id=gifr></div></div>
<form id=send class=send><button id=eBtn type=button class=icon>😊</button><button id=gBtn type=button class=icon>GIF</button><textarea id=msg placeholder="Type a message..."></textarea><div class=h><button id=draw type=button class=btn>✏️</button><button id=replyClear type=button class="btn hide">× Reply</button><button id=sBtn class="btn p" type=submit>Send</button></div></form>
</section>
</main>

<div id=modal class=modal><div class=p><div id=mb></div><div class=h style="justify-content:flex-end"><button id=mNo class=btn>Cancel</button><button id=mYes class="btn p">OK</button></div></div></div>
<div id=callm class=modal><div class=p><div class=note id=clab></div><div class=h style="gap:12px;align-items:start"><video id=lv autoplay playsinline muted style="width:48%;border:1px solid var(--brd);border-radius:12px;background:#000"></video><video id=rv autoplay playsinline style="width:48%;border:1px solid var(--brd);border-radius:12px;background:#000"></video></div><div class=h style="justify-content:flex-end"><button id=cEnd class=btn>End</button></div></div></div>
<div id=menu class=menu></div>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script type=module>
import{joinRoom,selfId}from"https://esm.run/trystero@0.21.8/torrent"
const U=i=>document.getElementById(i),Q=s=>document.querySelector(s),S={room:"",key:"",nick:"",dmWith:"",joined:false,roomObj:null,msgs:[],prefs:{theme:"system",anon:false,accent:"#6aa4ff"},avatar:"",bio:"",number:"",giphy:"",reply:null,blocks:[],contacts:[],gun:null,subs:{}}
const TTL=7,MAX=500,EMO="😀😄😁😆🤣🥲😊🙂😉😌😍🥰😘😜🤪🤨🫠🤗🤫🤔😴🤤😭😱😤😡👍👎👏🙏🤝💪🔥✨🎉💯❤️🧡💛💚💙💜🖤🤍🤎💤🍀🌙⭐🌈☕🍕🍔🍣🍪🍩🍫🍎🍌⚽🏀🎮🎧📷💡📎🔒🔑🧩🧪🛠️🚀".split("")
function b64u(a){return btoa(String.fromCharCode(...new Uint8Array(a))).replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}
function ub64(s){return Uint8Array.from(atob(s.replaceAll("-","+").replaceAll("_","/")),c=>c.charCodeAt(0))}
function rbytes(n){const b=new Uint8Array(n);crypto.getRandomValues(b);return b}
function rid(n=8){return Array.from(rbytes(n)).map(x=>(x&31).toString(36)).join("")}
function pass(){return b64u(rbytes(36))}
function slug(){const a=["nebula","sapphire","ember","polar","lunar","crimson","violet","amber","nova","coral","forest","arctic"],b=["otter","lynx","falcon","mako","gecko","puma","heron","ibis","bison","yak","orca","lemur"];return`${a[(Math.random()*a.length)|0]}-${b[(Math.random()*b.length)|0]}-${rid(4)}`}
function now(){return Date.now()}
function setCookie(k,v,d){const e=new Date(Date.now()+d*864e5).toUTCString();document.cookie=`${encodeURIComponent(k)}=${encodeURIComponent(v)}; expires=${e}; path=/; SameSite=Lax`}
function getCookie(k){const m=document.cookie.match(new RegExp("(?:^|; )"+encodeURIComponent(k)+"=([^;]*)"));return m?decodeURIComponent(m[1]):""}
function savePrefs(){setCookie("gtset",btoa(JSON.stringify(S.prefs)),365)}
function loadPrefs(){try{Object.assign(S.prefs,JSON.parse(atob(getCookie("gtset")||"{}")))}catch{};document.documentElement.style.setProperty("--acc",S.prefs.accent||"#6aa4ff");applyTheme()}
function applyTheme(){let t=S.prefs.theme;if(t==="system")t=matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";document.documentElement.setAttribute("data-theme",t);if(t==="light")document.body.style.background="var(--bg)"}
function setStatus(x){U("stat").textContent=x||""}
function info(x){U("warn").textContent=x||""}
function hasUrl(s){return/https?:\/\/[^\s]+/i.test(s)}
function urls(s){return(s.match(/https?:\/\/[^\s]+/ig)||[])}
function akey(pass){return crypto.subtle.importKey("raw",new TextEncoder().encode(pass),{name:"PBKDF2"},false,["deriveKey"])}
async function kdf(pass){const k=await akey(pass);return crypto.subtle.deriveKey({name:"PBKDF2",salt:new TextEncoder().encode("gt-salt"),iterations:200000,hash:"SHA-256"},k,{name:"AES-GCM",length:256},false,["encrypt","decrypt"])}
async function enc(o){if(!S.key)return{plain:o};const k=await kdf(S.key);const iv=rbytes(12);const pt=new TextEncoder().encode(JSON.stringify(o));const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},k,pt);return{v:1,i:b64u(iv),c:b64u(ct)}}
async function dec(env){if(env?.plain)return env.plain;if(!S.key)return null;try{const k=await kdf(S.key);const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:ub64(env.i)},{name:"AES-GCM"},ub64(env.c));return JSON.parse(new TextDecoder().decode(pt))}catch{return null}}
function sKey(room){return"store_"+room}
function pushStore(env){const arr=JSON.parse(localStorage.getItem(sKey(S.room))||"[]");arr.push({ts:now(),env});const cutoff=now()-TTL*864e5;const keep=arr.filter(x=>x.ts>=cutoff).slice(-4000);localStorage.setItem(sKey(S.room),JSON.stringify(keep))}
function readStore(){try{return JSON.parse(localStorage.getItem(sKey(S.room))||"[]")}catch{return[]}}
async function decryptAll(){const list=readStore();const out=[];for(const it of list){const o=await dec(it.env);if(o&&o.t)out.push(o)}return out}
function recents(){try{return JSON.parse(atob(getCookie("gt_rooms")||""))||[]}catch{return[]}}
function saveRecent(room){let a=recents().filter(x=>x.room!==room);a.unshift({room,last:now()});a=a.slice(0,10);setCookie("gt_rooms",btoa(JSON.stringify(a)),7);U("recent").innerHTML="";a.forEach(({room})=>{const b=document.createElement("button");b.className="chip";b.textContent=room;b.onclick=()=>quick(room);U("recent").appendChild(b)})}
function buildLink(room,key,nick){const u=new URL(location.href);u.searchParams.set("r",room);const h=new URLSearchParams();if(key)h.set("k",key);if(nick)h.set("n",nick);u.hash=h.toString();return u.toString()}
function parseLink(s){try{const u=new URL(s);const r=u.searchParams.get("r")||"";const h=new URLSearchParams(u.hash.replace(/^#/,""));const k=h.get("k")||u.searchParams.get("k")||"";const n=h.get("n")||"";return{room:r,key:k,nick:n}}catch{return{room:"",key:"",nick:""}}}
function devSecret(){let s=localStorage.getItem("gt_dev");if(!s){s=pass();localStorage.setItem("gt_dev",s)}return s}
async function localKey(){const base=await crypto.subtle.importKey("raw",new TextEncoder().encode(devSecret()),{name:"PBKDF2"},false,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:new TextEncoder().encode("gt-local"),iterations:150000,hash:"SHA-256"},base,{name:"AES-GCM",length:256},false,["encrypt","decrypt"])}
async function encLocal(s){const k=await localKey();const iv=rbytes(12);const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},k,new TextEncoder().encode(s));return JSON.stringify({i:b64u(iv),c:b64u(ct)})}
async function decLocal(j){try{const o=JSON.parse(j);const k=await localKey();const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:ub64(o.i)},k,ub64(o.c));return new TextDecoder().decode(pt)}catch{return""}}
async function savePass(room,pass){if(pass)localStorage.setItem("gt_pass_"+room,await encLocal(pass))}
async function loadPass(room){const j=localStorage.getItem("gt_pass_"+room);return j?await decLocal(j):""}
function base58(buf){const A="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";let x=[0];for(const b of buf){let c=b;for(let i=0;i<x.length;i++){const n=x[i]*256+c;x[i]=n%58;c=(n/58)|0}while(c){x.push(c%58);c=(c/58)|0}}return x.reverse().map(i=>A[i]).join("")||"1"}
async function hmac(d){const k=await crypto.subtle.importKey("raw",new TextEncoder().encode("numkey-v1"),{name:"HMAC",hash:"SHA-256"},false,["sign"]);const s=await crypto.subtle.sign("HMAC",k,new TextEncoder().encode(d));return new Uint8Array(s)}
async function myNumber(){const mac=await hmac(devSecret());return"N"+base58(mac.slice(0,10))}
function emojiPanel(){const g=U("eg");g.innerHTML="";EMO.forEach(e=>{const b=document.createElement("button");b.textContent=e;b.onclick=()=>{U("msg").value+=e;U("emoji").style.display="none";U("msg").focus()};g.appendChild(b)})}
function avatar(m){const im=document.createElement("img");im.className="ava";if(m.a)im.src=m.a;else{const c=document.createElement("canvas");c.width=64;c.height=64;const ctx=c.getContext("2d");ctx.fillStyle="#222";ctx.fillRect(0,0,64,64);ctx.fillStyle="#888";ctx.font="bold 30px system-ui";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText((m.u||"?").slice(0,1).toUpperCase(),32,38);im.src=c.toDataURL()}im.loading="lazy";return im}
function inbox(){try{return JSON.parse(localStorage.getItem("gt_inbox")||"[]")}catch{return[]}}
function setInbox(a){localStorage.setItem("gt_inbox",JSON.stringify(a));const n=a.filter(x=>!x.read).length;U("icount").style.display=n?"inline-block":"none";U("icount").textContent=n}
function addInbox(item){const a=inbox();a.unshift(item);setInbox(a.slice(0,100))}
function msgRow(m){const li=document.createElement("li");li.dataset.no=m.no||"";li.dataset.id=m.id||"";li.dataset.t=m.t;const av=avatar(m);av.title=(m.no||"");av.oncontextmenu=e=>openMenu(e,m);li.appendChild(av);const w=document.createElement("div");const meta=document.createElement("div");meta.className="meta";const rid=m.r&&m.r.t?` · reply to ${m.r.u||""}`:"";meta.textContent=`${m.u}${m.no?(" · "+m.no):""}${rid} · ${new Date(m.t).toLocaleString()}`;w.appendChild(meta);if(m.r&&m.r.text){const q=document.createElement("div");q.className="txt";q.style.opacity=.7;q.textContent="↪ "+m.r.text.slice(0,180);w.appendChild(q)}if(m.img){const im=document.createElement("img");im.src=m.img;im.className="gif";w.appendChild(im)}if(m.gif){const im=document.createElement("img");im.src=m.gif;im.className="gif";w.appendChild(im)}if(m.text){const t=document.createElement("div");t.className="txt";t.textContent=m.text;w.appendChild(t)}const act=document.createElement("div");act.className="meta";const rb=document.createElement("button");rb.className="btn";rb.textContent="↩︎ Reply";rb.onclick=()=>{S.reply={t:m.t,u:m.u,text:m.text||""};U("replyClear").classList.remove("hide")};act.appendChild(rb);w.appendChild(act);li.appendChild(w);return li}
function render(list){const ul=document.createElement("ul");list.slice().sort((a,b)=>a.t-b.t).forEach(m=>ul.appendChild(msgRow(m)));const box=U("msgs");box.innerHTML="";box.appendChild(ul);box.scrollTop=box.scrollHeight}
function merge(newOnes){const seen=new Set(S.msgs.map(m=>m.t+":"+(m.no||"")+":"+(m.id||"")));newOnes.forEach(m=>{if(m.no&&S.blocks.includes(m.no))return;const k=m.t+":"+(m.no||"")+":"+(m.id||"");if(!seen.has(k)){S.msgs.push(m);seen.add(k);if((m.r&&m.r.id===selfId)||(S.room.startsWith("dm-")&&m.no!==S.number)){addInbox({t:m.t,from:m.u,preview:(m.text||m.gif?"(media)":"(img)")})}}});S.msgs=S.msgs.slice(-MAX);render(S.msgs)}
function tabs(){const t=(id,p)=>{
U("tJoin").classList.toggle("a",id==="tJoin");U("tCreate").classList.toggle("a",id==="tCreate");U("tPub").classList.toggle("a",id==="tPub");U("tDM").classList.toggle("a",id==="tDM");
U("pJoin").classList.toggle("hide",p!=="pJoin");U("pCreate").classList.toggle("hide",p!=="pCreate");U("pPub").classList.toggle("hide",p!=="pPub");U("pDM").classList.toggle("hide",p!=="pDM")};
U("tJoin").onclick=()=>t("tJoin","pJoin");U("tCreate").onclick=()=>t("tCreate","pCreate");U("tPub").onclick=()=>t("tPub","pPub");U("tDM").onclick=()=>t("tDM","pDM")}
function pubs(){["lobby","global","tech","games"].forEach(n=>{const b=document.createElement("button");b.className="chip";b.textContent=n;b.onclick=async()=>{await ensureNick();join({room:n,key:""})};U("pubs").appendChild(b)})}
function applyHeader(){U("roomtag").textContent=(S.room.startsWith("dm-")?"Private: ":"Room: ")+S.room;U("metag").textContent="You: "+S.nick+" · "+selfId.slice(0,6);U("numtag").textContent="Number: "+(S.prefs.anon?"Hidden":S.number);["roomtag","metag","numtag","share","leave"].forEach(id=>U(id).classList.remove("hide"));U("call").classList.toggle("hide",!S.room.startsWith("dm-"));U("qr").classList.remove("hide")}
async function ensureNick(){if(S.prefs.anon){S.nick="anon-"+rid(6);return true}let saved=(localStorage.getItem("gt_nick")||"").trim();if(saved){S.nick=saved;return true}
U("mb").innerHTML=`<div class=row><div><small>Choose a username</small><input id=asknick></div></div>`;U("mYes").textContent="Continue";U("mNo").textContent="Cancel";U("modal").style.display="flex";return new Promise(res=>{U("mYes").onclick=()=>{const v=(Q("#asknick").value||"").trim();if(!v)return;localStorage.setItem("gt_nick",v);S.nick=v;U("modal").style.display="none";res(true)};U("mNo").onclick=()=>{U("modal").style.display="none";res(false)}})}
function ensureGun(){if(S.gun)return;S.gun=Gun({peers:["https://relay.peer.ooo/gun","https://gun-manhattan.herokuapp.com/gun"]})}
function gunNode(r){ensureGun();return S.gun.get("githubtalk2").get("rooms").get(r)}
async function gunPush(env,ts){try{gunNode(S.room).get("msgs").get(String(ts)).put(env)}catch{}}
function gunSub(room){ensureGun();if(S.subs[room])return;const cutoff=now()-TTL*864e5;S.subs[room]=gunNode(room).get("msgs").map().on(async(env)=>{if(!env)return;const m=await dec(env);if(m&&m.t>=cutoff){pushStore(env);merge([m])}})}
async function gunWarm(room){ensureGun();const cutoff=now()-TTL*864e5;const list=[];await new Promise(r=>{let d=false;const n=gunNode(room).get("msgs");const t=setTimeout(()=>{if(!d)r()},900);n.map().once(async env=>{if(env){const m=await dec(env);if(m&&m.t>=cutoff)list.push(m)}},()=>{});setTimeout(()=>{d=true;clearTimeout(t);r()},1000)});if(list.length)merge(list.sort((a,b)=>a.t-b.t).slice(-MAX))}
async function send({text,gif,img}){if(!S.roomObj)return;const[sendMsg]=S.roomObj.makeAction("msg");const m={t:now(),u:S.nick,id:selfId};if(S.avatar)m.a=S.avatar;if(!S.prefs.anon&&S.number)m.no=S.number;if(S.bio)m.pb=S.bio;if(text)m.text=text;if(gif)m.gif=gif;if(img)m.img=img;if(S.reply){m.r=Object.assign({id:selfId},S.reply);S.reply=null;U("replyClear").classList.add("hide")}const env=await enc(m);await sendMsg(env);S.msgs.push(m);render(S.msgs);pushStore(env);await gunPush(env,m.t)}
async function historyReq(roomObj){const[sendReq,getReq]=roomObj.makeAction("hreq");const[sendRes,getRes]=roomObj.makeAction("hres");getReq(async payload=>{const cmd=await dec(payload);if(!cmd)return;const plain=await decryptAll();const pack=plain.filter(m=>m.t>=(cmd.since||0)).slice(-MAX);const env=await enc({history:pack});await sendRes(env)});getRes(async payload=>{const d=await dec(payload);if(d&&Array.isArray(d.history))merge(d.history)});const cutoff=now()-TTL*864e5;await sendReq(await enc({since:cutoff}))}
async function join(o={}){U("join").classList.add("hide");U("chat").classList.remove("hide");S.room=(o.room||U("room").value||slug()).trim();S.key=(o.key??pass()).trim();S.nick=(o.nick||localStorage.getItem("gt_nick")||"").trim()||(S.prefs.anon?("anon-"+rid(6)):("anon-"+rid(6)));S.dmWith=o.dmWith||"";await savePass(S.room,S.key);saveRecent(S.room);applyHeader();const cfg={appId:"githubtalk2",password:S.key||undefined};const room=joinRoom(cfg,S.room);S.roomObj=room;const[sendMsg,getMsg]=room.makeAction("msg");getMsg(async(payload,peerId)=>{const d=await dec(payload);if(d){pushStore(payload);merge([d]);await gunPush(payload,d.t);setStatus(`Last from ${peerId.slice(0,6)} · ${new Date().toLocaleTimeString()}`)}});room.onPeerJoin(pid=>setStatus(`Peer joined: ${pid.slice(0,6)} · ${new Date().toLocaleTimeString()}`));room.onPeerLeave(pid=>setStatus(`Peer left: ${pid.slice(0,6)} · ${new Date().toLocaleTimeString()}`));merge(await decryptAll());setStatus("Online · "+new Date().toLocaleTimeString());S.joined=true;await historyReq(room);gunSub(S.room);await gunWarm(S.room)}
function leave(){try{S.roomObj?.leave?.()}catch{}S.room="";S.key="";S.roomObj=null;S.msgs=[];U("msgs").innerHTML="";U("chat").classList.add("hide");U("join").classList.remove("hide");["share","leave","call","qr","roomtag","metag","numtag"].forEach(id=>U(id).classList.add("hide"));setStatus("")}
async function quick(r){if(!(await ensureNick()))return;const k=await loadPass(r);await join({room:r,key:k||"",nick:S.nick})}
async function myPeer(){if(S.peer)return;S.peer=new Peer("gt-"+S.number);S.peer.on("call",async c=>{U("clab").textContent="Incoming call";U("callm").style.display="flex";const s=await media();S.stream=s;U("lv").srcObject=s;c.answer(s);c.on("stream",v=>U("rv").srcObject=v)})}
async function media(){return await navigator.mediaDevices.getUserMedia({video:true,audio:true})}
async function call(){if(!S.room.startsWith("dm-"))return;await myPeer();U("clab").textContent="Calling "+S.dmWith;U("callm").style.display="flex";const s=await media();S.stream=s;U("lv").srcObject=s;const c=S.peer.call("gt-"+S.dmWith,s);c.on("stream",v=>U("rv").srcObject=v)}
function endCall(){U("callm").style.display="none";try{U("lv").srcObject&&U("lv").srcObject.getTracks().forEach(t=>t.stop());U("rv").srcObject&&U("rv").srcObject.getTracks().forEach(t=>t.stop())}catch{}}
async function startDMWith(no){const me=S.number;const pair=[me,no].sort().join("-");const room="dm-"+await hashStr(pair);const key=await hashStr("k:"+pair);await join({room,key,nick:S.prefs.anon?("anon-"+rid(6)):S.nick,dmWith:no})}
async function hashStr(s){const h=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(s));return base58(new Uint8Array(h).slice(0,16))}
function openMenu(e,m){e.preventDefault();const menu=U("menu");const canAct=!!m.no;menu.innerHTML=`<button data-a="dm" ${!canAct?"disabled":""}>DM</button><button data-a="blk" ${!canAct?"disabled":""}>${S.blocks.includes(m.no)?"Unblock":"Block"}</button><button data-a="qr">Share QR</button>${m.no?"<button data-a='addc'>Add contact</button>":""}`;menu.style.display="block";menu.style.left=e.pageX+"px";menu.style.top=e.pageY+"px";menu.onclick=ev=>{const a=ev.target.getAttribute("data-a");menu.style.display="none";if(a==="dm"&&m.no)startDMWith(m.no);if(a==="blk"&&m.no){if(S.blocks.includes(m.no))S.blocks=S.blocks.filter(x=>x!==m.no);else S.blocks.push(m.no);setCookie("gt_blocks",btoa(JSON.stringify(S.blocks)),365);render(S.msgs.filter(x=>!x.no||!S.blocks.includes(x.no)))}if(a==="qr"){shareQR()}if(a==="addc"&&m.no){if(!S.contacts.find(x=>x.no===m.no)){S.contacts.push({no:m.no,name:m.u});setCookie("gt_contacts",btoa(JSON.stringify(S.contacts)),365)}}}
document.onclick=()=>menu.style.display="none"}
function people(){const me=`<div class=chip>My Number: <b>${S.number}</b></div>`;const list=S.contacts.map(c=>`<div class=h style="justify-content:space-between;border:1px solid var(--brd);padding:8px;border-radius:10px;width:100%"><div><b>${c.name||c.no}</b><div class=note>${c.no}</div></div><div class=h><button data-a="dm" data-no="${c.no}" class=btn>DM</button><button data-a="blk" data-no="${c.no}" class=btn>${S.blocks.includes(c.no)?"Unblock":"Block"}</button><button data-a="del" data-no="${c.no}" class=btn>Remove</button></div></div>`).join("")||"<div class=note>No contacts yet</div>";U("mb").innerHTML=`<div class=h style="margin-bottom:8px">${me}<button id=copyNum class=btn>Copy</button></div><div class=row><div><input id=addNo placeholder="N..."></div><div><input id=addName placeholder="Name (opt)"></div></div><div class=h style=margin-top:8px><button id=addBtn class="btn p">Add</button></div><hr style="border:0;border-top:1px solid var(--brd);margin:10px 0"><div id=cl>${list}</div>`;U("modal").style.display="flex";U("mYes").onclick=()=>U("modal").style.display="none";U("mNo").onclick=()=>U("modal").style.display="none";U("copyNum").onclick=async()=>{try{await navigator.clipboard.writeText(S.number)}catch{}};U("addBtn").onclick=()=>{const no=(Q("#addNo").value||"").trim();if(!no)return;const name=(Q("#addName").value||"").trim();if(!S.contacts.find(x=>x.no===no))S.contacts.push({no,name});setCookie("gt_contacts",btoa(JSON.stringify(S.contacts)),365);U("modal").style.display="none";people()};Q("#cl").onclick=e=>{const b=e.target.closest("button");if(!b)return;const a=b.getAttribute("data-a"),no=b.getAttribute("data-no");if(a==="dm")startDMWith(no);if(a==="del"){S.contacts=S.contacts.filter(x=>x.no!==no);setCookie("gt_contacts",btoa(JSON.stringify(S.contacts)),365);people()}if(a==="blk"){if(S.blocks.includes(no))S.blocks=S.blocks.filter(x=>x!==no);else S.blocks.push(no);setCookie("gt_blocks",btoa(JSON.stringify(S.blocks)),365);people()}}}
function settings(){const theme=`<select id=setTheme><option value=system ${S.prefs.theme==="system"?"selected":""}>System</option><option value=dark ${S.prefs.theme==="dark"?"selected":""}>Dark</option><option value=light ${S.prefs.theme==="light"?"selected":""}>Light</option></select>`;const anon=S.prefs.anon?"checked":"";const acc=S.prefs.accent;const bio=S.bio||getCookie("gt_bio")||"";U("mb").innerHTML=`<div class=row><div><small>Username</small><input id=setNick value="${(localStorage.getItem("gt_nick")||"")}"></div><div><small>Theme</small>${theme}</div></div><div class=row style=margin-top:8px><div><small>Accent</small><input id=setAcc type=color value=${acc}></div><div><label><input type=checkbox id=setAnon ${anon}> Anonymous this session</label></div></div><div class=row style=margin-top:8px><div><small>Bio</small><textarea id=setBio rows=3 placeholder="About you...">${bio}</textarea></div><div><small>Profile picture</small><canvas id=pf width=240 height=160 style="width:100%;border:1px solid var(--brd);border-radius:12px;background:#111;touch-action:none"></canvas><div class=h><button id=pfClear class=btn>Clear</button><button id=pfSave class="btn p">Save</button></div></div></div>`;U("modal").style.display="flex";const c=Q("#pf"),x=c.getContext("2d");let d=false,last=[0,0];x.lineCap="round";x.lineJoin="round";x.lineWidth=4;x.strokeStyle="#fff";const av=S.avatar||getCookie("gt_avatar")||"";if(av){const i=new Image;i.onload=()=>x.drawImage(i,0,0,c.width,c.height);i.src=av}const pos=e=>{const r=c.getBoundingClientRect();const sx=c.width/r.width,sy=c.height/r.height;const px=(e.touches?e.touches[0].clientX:e.clientX)-r.left,py=(e.touches?e.touches[0].clientY:e.clientY)-r.top;return[px*sx,py*sy]};c.addEventListener("pointerdown",e=>{d=true;last=pos(e)});c.addEventListener("pointermove",e=>{if(!d)return;const[p,q]=pos(e);x.beginPath();x.moveTo(last[0],last[1]);x.lineTo(p,q);x.stroke();last=[p,q]});c.addEventListener("pointerup",()=>d=false);c.addEventListener("pointerleave",()=>d=false);U("pfClear").onclick=()=>x.clearRect(0,0,c.width,c.height);U("pfSave").onclick=()=>{const data=c.toDataURL("image/png");setCookie("gt_avatar",data,365);S.avatar=data};U("mYes").onclick=()=>{const n=(Q("#setNick").value||"").trim();const t=Q("#setTheme").value;const a=Q("#setAnon").checked;const ac=Q("#setAcc").value;const b=(Q("#setBio").value||"").trim();S.prefs.theme=t;S.prefs.anon=a;S.prefs.accent=ac;S.bio=b;setCookie("gt_bio",b,365);document.documentElement.style.setProperty("--acc",ac);applyTheme();savePrefs();if(n&&!a)localStorage.setItem("gt_nick",n);if(a)S.nick="anon-"+rid(6);U("modal").style.display="none"};U("mNo").onclick=()=>U("modal").style.display="none"}
function shareQR(){const link=buildLink(S.room,S.key,S.nick);U("mb").innerHTML=`<div class=h><div id=qrc></div><div class=h><button id=qcopy class="btn p">Copy</button></div></div>`;U("modal").style.display="flex";QRious?null:QRCode.toCanvas(document.createElement("canvas"),link,{width:240},(err,canvas)=>{if(!err){canvas.style.border="1px solid var(--brd)";canvas.style.borderRadius="12px";Q("#qrc").appendChild(canvas)}});U("qcopy").onclick=async()=>{try{await navigator.clipboard.writeText(link)}catch{}};U("mYes").onclick=()=>U("modal").style.display="none";U("mNo").onclick=()=>U("modal").style.display="none"}
async function gifSearch(q){const key=S.giphy||localStorage.getItem("gt_giphy_key")||"dc6zaTOxFJmzC";const ep=q?`https://api.giphy.com/v1/gifs/search?api_key=${encodeURIComponent(key)}&q=${encodeURIComponent(q)}&limit=24&rating=pg-13`:`https://api.giphy.com/v1/gifs/trending?api_key=${encodeURIComponent(key)}&limit=24&rating=pg-13`;try{const r=await fetch(ep);const j=await r.json();const g=U("gifr");g.innerHTML="";(j.data||[]).forEach(d=>{const url=(d.images?.downsized?.url)||d.images?.original?.url;if(!url)return;const im=document.createElement("img");im.src=url;im.onclick=async()=>{await send({gif:url});U("gifp").style.display="none"};g.appendChild(im)})}catch{}}
U("pub").onclick=()=>{U("tPub").click();scrollTo({top:0,behavior:"smooth"})}
U("sett").onclick=settings
U("people").onclick=people
U("rand").onclick=()=>{ensureGun();if(S.subs._rnd){S.subs._rnd=null;U("rand").textContent="Random";try{S.gun.get("githubtalk2").get("queue").get(selfId).put(null)}catch{}return}S.subs._rnd=true;U("rand").textContent="Cancel";const offer={by:selfId,t:now(),room:slug(),key:pass()};S.gun.get("githubtalk2").get("queue").get(selfId).put(offer);const q=S.gun.get("githubtalk2").get("queue");const sub=q.map().on(async(o,k)=>{if(!S.subs._rnd||!o||k===selfId)return;if(now()-o.t>120000)return;q.get(k).get("take").once(v=>{if(v||!S.subs._rnd)return;q.get(k).get("take").put(selfId);S.subs._rnd=false;U("rand").textContent="Random";q.get(selfId).put(null);q.get(k).put(Object.assign({},o,{take:selfId}));join({room:o.room,key:o.key,nick:S.prefs.anon?("anon-"+rid(6)):(localStorage.getItem("gt_nick")||"")});setTimeout(()=>q.get(k).put(null),5000)})});S.subs._rnd=sub}
U("mk").onclick=async()=>{if(!await ensureNick())return;const r=(U("room").value||slug()).trim();const k=(U("pass").value||pass()).trim();const n=S.nick||("anon-"+rid(6));const link=buildLink(r,k,n);try{await navigator.clipboard.writeText(link)}catch{info("Invite: "+link)}await join({room:r,key:k,nick:n})}
U("go").onclick=async()=>{if(!await ensureNick())return;const pasted=U("invite").value.trim();let r="",k="",n="";if(pasted){const x=parseLink(pasted);r=x.room;k=x.key;n=x.nick}if(!r){const u=new URL(location.href);r=u.searchParams.get("r")||"";const h=new URLSearchParams(u.hash.replace(/^#/,""));k=h.get("k")||"";n=h.get("n")||""}if(!r){info("Invite link required");return}if(k==="")k=await loadPass(r)||"";await join({room:r,key:k,nick:n||S.nick})}
U("dmStart").onclick=async()=>{const no=(U("dmNum").value||"").trim();if(no)await startDMWith(no)}
U("share").onclick=async()=>{try{await navigator.clipboard.writeText(buildLink(S.room,S.key,S.nick))}catch{}}
U("qr").onclick=shareQR
U("leave").onclick=leave
U("call").onclick=call
U("cEnd").onclick=endCall
U("send").addEventListener("submit",async e=>{e.preventDefault();const t=(U("msg").value||"").trim();if(!t)return;if(hasUrl(t)){U("mb").innerHTML=`<div class=note>This message contains a URL. Links can be dangerous. Send anyway?</div>`;U("modal").style.display="flex";U("mYes").onclick=async()=>{U("modal").style.display="none";U("msg").value="";await send({text:t})};U("mNo").onclick=()=>U("modal").style.display="none";return}U("msg").value="";await send({text:t})})
U("eBtn").onclick=()=>{const p=U("emoji");p.style.display=p.style.display==="block"?"none":"block"}
U("gBtn").onclick=async()=>{U("gifp").style.display="block";U("gq").focus();await gifSearch("trending")}
U("gx").onclick=()=>U("gifp").style.display="none"
U("gk").onclick=async()=>{U("mb").innerHTML=`<div class=row><div><small>GIPHY API Key</small><input id=gkey></div></div>`;U("modal").style.display="flex";U("mYes").onclick=()=>{const v=(Q("#gkey").value||"").trim();if(v){S.giphy=v;localStorage.setItem("gt_giphy_key",v)}U("modal").style.display="none"};U("mNo").onclick=()=>U("modal").style.display="none"}
U("gq").addEventListener("input",e=>{clearTimeout(U("gq")._t);U("gq")._t=setTimeout(()=>gifSearch(U("gq").value.trim()),300)})
U("draw").onclick=()=>{U("mb").innerHTML=`<div class=row><div><canvas id=dc width=640 height=400 style="width:100%;border:1px solid var(--brd);border-radius:12px;background:#111;touch-action:none"></canvas></div></div><div class=h><input type=range id=dw min=1 max=16 value=4 style=width:160px><input type=color id=dcx value=#ffffff><button id=dcls class=btn>Clear</button></div>`;U("modal").style.display="flex";const c=Q("#dc"),x=c.getContext("2d");let d=false,last=[0,0];x.lineCap="round";x.lineJoin="round";function pos(e){const r=c.getBoundingClientRect(),sx=c.width/r.width,sy=c.height/r.height;const px=(e.touches?e.touches[0].clientX:e.clientX)-r.left,py=(e.touches?e.touches[0].clientY:e.clientY)-r.top;return[px*sx,py*sy]}c.onpointerdown=e=>{d=true;last=pos(e)};c.onpointermove=e=>{if(!d)return;const[p,q]=pos(e);x.strokeStyle=Q("#dcx").value;x.lineWidth=+Q("#dw").value;x.beginPath();x.moveTo(last[0],last[1]);x.lineTo(p,q);x.stroke();last=[p,q]};c.onpointerup=()=>d=false;c.onpointerleave=()=>d=false;U("dcls").onclick=()=>x.clearRect(0,0,c.width,c.height);U("mYes").onclick=async()=>{const data=c.toDataURL("image/png");U("modal").style.display="none";await send({img:data})};U("mNo").onclick=()=>U("modal").style.display="none"}
U("replyClear").onclick=()=>{S.reply=null;U("replyClear").classList.add("hide")}
U("ibox").onclick=()=>{const a=inbox();const list=a.map((x,i)=>`<div class=h style="justify-content:space-between;border:1px solid var(--brd);padding:8px;border-radius:10px"><div><b>${x.from||"Someone"}</b><div class=note>${new Date(x.t).toLocaleString()}</div></div><div>${x.preview||""}</div><button data-i=${i} class=btn>Read</button></div>`).join("")||"<div class=note>Empty</div>";U("mb").innerHTML=list;U("modal").style.display="flex";U("mb").onclick=e=>{const b=e.target.closest("button");if(!b)return;const i=+b.getAttribute("data-i");const arr=inbox();if(arr[i])arr[i].read=true;setInbox(arr);U("modal").style.display="none"}
U("mYes").onclick=()=>U("modal").style.display="none";U("mNo").onclick=()=>U("modal").style.display="none"}
emojiPanel();tabs();pubs();loadPrefs();applyTheme();
S.avatar=getCookie("gt_avatar")||"";S.bio=getCookie("gt_bio")||"";S.number=await myNumber();U("numtag").classList.remove("hide");U("numtag").textContent="Number: "+S.number;try{S.contacts=JSON.parse(atob(getCookie("gt_contacts")||""))||[]}catch{};try{S.blocks=JSON.parse(atob(getCookie("gt_blocks")||""))||[]}catch{};const rs=new URLSearchParams(location.search),r=rs.get("r")||"";if(r){U("invite").value=location.href;U("tJoin").click()}const h=new URLSearchParams(location.hash.replace(/^#/,""));const k=h.get("k")||"",n=h.get("n")||"";setInbox(inbox())
</script>
</body></html>
