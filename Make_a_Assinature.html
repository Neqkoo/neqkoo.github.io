<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CICADA-ish Signer (2008 Raw Style)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* === 2008-ish raw look === */
    body {
      background: #ececec url('data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==') repeat;
      color: #222;
      font: 13px/1.4 "Courier New", Courier, monospace;
    }
    #wrap {
      width: 900px;
      margin: 24px auto;
      border: 1px solid #444;
      background: #f7f7f7;
      box-shadow: 0 0 0 1px #fff inset;
    }
    #titlebar {
      padding: 10px 12px;
      background: #dcdcdc;
      border-bottom: 1px solid #444;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    #titlebar b {
      display: inline-block;
      padding: 2px 6px;
      margin-right: 6px;
      border: 1px solid #222;
      background: linear-gradient(#fff, #d9d9d9);
    }
    .panel { padding: 12px; border-top: 1px dashed #aaa; }
    .row { margin: 10px 0; }
    label { display: block; margin-bottom: 4px; font-weight: bold; text-shadow: 0 1px 0 #fff; }
    textarea, input[type="text"] {
      width: 100%; box-sizing: border-box; padding: 8px;
      border: 1px solid #666; background: #fff;
      font: 13px "Courier New", Courier, monospace;
      resize: vertical; min-height: 64px;
    }
    textarea.small { min-height: 50px; }
    .buttons { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
    button {
      border: 1px solid #222; background: linear-gradient(#ffffff, #dddddd);
      padding: 6px 10px; cursor: pointer;
    }
    button:active { background: linear-gradient(#dcdcdc, #f0f0f0); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .status { margin-top: 10px; padding: 8px; border: 1px solid #999; background: #ffffe0; white-space: pre-wrap; min-height: 24px; }
    .hint { color: #555; font-style: italic; margin-top: 6px; }
    .badge { display:inline-block; font-weight:bold; padding:2px 4px; border:1px solid #444; background:#eaeaea; margin-right:6px; }
    .footer { padding: 10px 12px; border-top: 1px solid #444; background: #eee; font-size: 12px; }
    .warn { color:#b00000; font-weight:bold; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="titlebar">
      <span class="badge">ASCII WEB</span>
      <b>CICADA-ish Signer</b> <span style="opacity:.75">• raw 2008 vibe</span>
    </div>

    <div class="panel">
      <div class="row">
        <label for="msg">Message</label>
        <textarea id="msg" spellcheck="false" placeholder="Type the message you want to sign...">The quick brown fox jumps over the lazy dog.</textarea>
      </div>

      <div class="grid">
        <div class="row">
          <label for="pubkey">Public Key (PEM, SPKI)</label>
          <textarea id="pubkey" class="small" spellcheck="false" placeholder="-----BEGIN PUBLIC KEY-----
..."></textarea>
          <div class="buttons">
            <button id="copyPub">Copy Public</button>
            <button id="clearPub">Clear</button>
          </div>
        </div>
        <div class="row">
          <label for="privkey">Private Key (PEM, PKCS#8)</label>
          <textarea id="privkey" class="small" spellcheck="false" placeholder="-----BEGIN PRIVATE KEY-----
..."></textarea>
          <div class="buttons">
            <button id="copyPriv">Copy Private</button>
            <button id="clearPriv">Clear</button>
          </div>
        </div>
      </div>

      <div class="row">
        <label for="sig">Signature (Base64)</label>
        <textarea id="sig" class="small" spellcheck="false" placeholder="Base64 signature will appear here..."></textarea>
        <div class="buttons">
          <button id="copySig">Copy Signature</button>
          <button id="clearSig">Clear</button>
        </div>
      </div>

      <div class="buttons">
        <button id="gen">Generate RSA Keys</button>
        <button id="sign">Sign Message</button>
        <button id="verify">Verify Signature</button>
        <button id="clearAll">Clear All</button>
      </div>

      <div class="hint">
        Tip: This uses RSA-PSS with SHA-256 (similar spirit to PGP-style signatures Cicada fans love). Keep your private key safe.
      </div>

      <div id="status" class="status">Ready.</div>
      <div id="secureWarn" class="hint"></div>
    </div>

    <div class="footer">
      Works best over <span class="warn">https://</span> or <span class="warn">http://localhost</span> (browsers may block crypto on plain file://). No servers involved – all in your browser.
    </div>
  </div>

<script>
(function(){
  // --- Helpers ---
  const $ = (id) => document.getElementById(id);
  const enc = new TextEncoder();

  function setStatus(msg) { $("status").textContent = msg; }
  function appendStatus(msg) { $("status").textContent += "\\n" + msg; }

  function ab2b64(buf){
    const bytes = new Uint8Array(buf);
    let binary = "";
    for (let i=0; i<bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
  }
  function b642ab(b64){
    const binary = atob(b64.replace(/\\s+/g,''));
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for (let i=0; i<len; i++) bytes[i] = binary.charCodeAt(i);
    return bytes.buffer;
  }
  function wrapPEM(base64, label){
    const lines = base64.match(/.{1,64}/g).join("\\n");
    return "-----BEGIN " + label + "-----\\n" + lines + "\\n-----END " + label + "-----";
  }
  function stripPEM(pem){
    return pem.replace(/-----BEGIN [^-]+-----/g,'')
              .replace(/-----END [^-]+-----/g,'')
              .replace(/\\s+/g,'');
  }
  function copy(el){
    el.select();
    document.execCommand('copy');
  }
  function checkSecureContext(){
    if (!window.isSecureContext) {
      $("secureWarn").innerHTML = "⚠ Your page is not in a secure context. If Crypto fails, open this file via a tiny local server (e.g., <code>python -m http.server</code>) or use <code>http://localhost</code> / <code>https://</code>.";
    }
  }

  checkSecureContext();

  // --- Crypto params (RSA-PSS w/ SHA-256) ---
  const algo = {
    name: "RSA-PSS",
    modulusLength: 2048,
    publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
    hash: "SHA-256"
  };
  const signParams = { name: "RSA-PSS", saltLength: 32 };

  let privKey = null;
  let pubKey  = null;

  async function generate(){
    try {
      setStatus("Generating 2048-bit RSA keypair...");
      const kp = await crypto.subtle.generateKey(algo, true, ["sign","verify"]);
      privKey = kp.privateKey;
      pubKey  = kp.publicKey;

      const spki = await crypto.subtle.exportKey("spki", pubKey);
      const pkcs8 = await crypto.subtle.exportKey("pkcs8", privKey);

      $("pubkey").value  = wrapPEM(ab2b64(spki), "PUBLIC KEY");
      $("privkey").value = wrapPEM(ab2b64(pkcs8), "PRIVATE KEY");
      setStatus("Keypair generated. Public/Private PEMs filled in.");
    } catch (e){
      setStatus("Failed to generate keys: " + e);
    }
  }

  async function importKeysFromTextareas(){
    try {
      const pubText = $("pubkey").value.trim();
      const privText = $("privkey").value.trim();
      if (pubText) {
        const spkiBuf = b642ab(stripPEM(pubText));
        pubKey = await crypto.subtle.importKey(
          "spki",
          spkiBuf,
          { name: "RSA-PSS", hash: "SHA-256" },
          true,
          ["verify"]
        );
      }
      if (privText) {
        const pkcs8Buf = b642ab(stripPEM(privText));
        privKey = await crypto.subtle.importKey(
          "pkcs8",
          pkcs8Buf,
          { name: "RSA-PSS", hash: "SHA-256" },
          true,
          ["sign"]
        );
      }
      return true;
    } catch (e){
      setStatus("Key import error: " + e);
      throw e;
    }
  }

  async function sign(){
    try {
      await importKeysFromTextareas();
      if (!privKey) {
        setStatus("No private key. Generate or paste a PKCS#8 private key.");
        return;
      }
      const data = enc.encode($("msg").value);
      const sig = await crypto.subtle.sign(signParams, privKey, data);
      const b64 = ab2b64(sig);
      $("sig").value = b64;
      setStatus("Signed message. Signature (Base64) updated.");
    } catch (e){
      appendStatus("Sign error: " + e);
    }
  }

  async function verify(){
    try {
      await importKeysFromTextareas();
      if (!pubKey) {
        setStatus("No public key. Generate or paste an SPKI public key.");
        return;
      }
      const data = enc.encode($("msg").value);
      const sigText = $("sig").value.trim();
      if (!sigText) { setStatus("Paste a Base64 signature to verify."); return; }
      const sig = b642ab(sigText);
      const ok = await crypto.subtle.verify(signParams, pubKey, sig, data);
      setStatus(ok ? "✅ Signature is VALID for this message & public key." : "❌ Signature is NOT valid.");
    } catch (e){
      appendStatus("Verify error: " + e);
    }
  }

  // --- Wire up UI ---
  $("gen").addEventListener("click", generate);
  $("sign").addEventListener("click", sign);
  $("verify").addEventListener("click", verify);
  $("clearAll").addEventListener("click", () => {
    $("msg").value = "";
    $("pubkey").value = "";
    $("privkey").value = "";
    $("sig").value = "";
    setStatus("Cleared.");
  });
  $("copyPub").addEventListener("click", () => copy($("pubkey")));
  $("copyPriv").addEventListener("click", () => copy($("privkey")));
  $("copySig").addEventListener("click", () => copy($("sig")));
  $("clearPub").addEventListener("click", () => $("pubkey").value = "");
  $("clearPriv").addEventListener("click", () => $("privkey").value = "");
  $("clearSig").addEventListener("click", () => $("sig").value = "");

  // Feature detect
  if (!window.crypto || !crypto.subtle) {
    setStatus("Your browser does not support Web Crypto (SubtleCrypto). Try a modern browser over HTTPS/localhost.");
  }
})();
</script>
</body>
</html>
