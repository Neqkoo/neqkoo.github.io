<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Capcut-ish 2008</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#dcdcdc;font-family:Tahoma,Arial,sans-serif;color:#111}
#wrap{max-width:1100px;margin:0 auto;padding:10px}
.header{background:linear-gradient(#3b6ea5,#2b4f78);color:#fff;padding:14px 16px;border:1px solid #1e3b5c;border-radius:6px;box-shadow:0 2px 0 #16314d,0 3px 10px rgba(0,0,0,.2);text-shadow:0 1px 0 #000}
.header h1{margin:0;font-size:22px;letter-spacing:.5px}
.layout{display:flex;gap:12px;margin-top:12px}
.panel{flex:1;background:#f0f0f0;border:1px solid #bdbdbd;border-radius:6px;box-shadow:inset 0 1px 0 #fff,0 2px 0 #b2b2b2}
.panel h2{font-size:14px;margin:0;padding:8px 10px;background:linear-gradient(#ffffff,#e8e8e8);border-bottom:1px solid #c9c9c9}
.panel .body{padding:10px}
fieldset{border:1px solid #c6c6c6;border-radius:4px;margin:0 0 10px 0;padding:8px;background:#fff}
legend{padding:0 6px;background:#fff;border:1px solid #c6c6c6;border-radius:4px}
label{display:block;font-size:12px;margin:6px 0 2px}
input[type="file"]{width:100%}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.row>div{flex:1;min-width:120px}
.small{font-size:11px;color:#333}
.btn{appearance:none;border:1px solid #2b4f78;background:linear-gradient(#5fa0e0,#3c78b4);color:#fff;padding:8px 12px;border-radius:5px;box-shadow:inset 0 1px 0 #9dd0ff,0 2px 0 #264b71;cursor:pointer;font-weight:bold}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.alt{border-color:#5b5b5b;background:linear-gradient(#fefefe,#cfcfcf);color:#222;box-shadow:inset 0 1px 0 #fff,0 2px 0 #9a9a9a}
.kv{display:flex;justify-content:space-between;gap:6px}
.kv input[type="number"],.kv input[type="text"],.kv select{width:100%}
.sl{display:flex;align-items:center;gap:6px}
.output{padding:8px;background:#fff;border:1px dashed #9b9b9b;border-radius:4px}
hr.sep{border:0;border-top:1px solid #c9c9c9;margin:10px 0}
#previewBox{background:#000;border:1px solid #333;border-radius:6px;display:flex;align-items:center;justify-content:center;min-height:360px;position:relative}
#canvas{max-width:100%;border-radius:6px}
.meta{font-size:11px;color:#111;background:#fff;border:1px solid #c9c9c9;border-radius:4px;padding:6px;margin-top:8px}
.badge{display:inline-block;background:#ffd85a;border:1px solid #c59b1d;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:6px}
.switch{display:flex;gap:10px;font-size:12px}
.switch label{display:flex;align-items:center;gap:6px;margin:0}
footer{margin:16px 0 6px;color:#444;font-size:11px;text-align:center}
.tablelike{display:grid;grid-template-columns:1fr auto;gap:6px}
input[type="range"]{width:100%}
a.link{color:#0b58b0;text-decoration:none;border-bottom:1px dotted #0b58b0}
.mono{font-family:Consolas,Monaco,monospace}
</style>
</head>
<body>
<div id="wrap">
<div class="header"><h1>Capcut-ish 2008 <span class="badge">beta</span></h1></div>
<div class="layout">
<div class="panel" style="flex:1.2">
<h2>Media</h2>
<div class="body">
<fieldset>
<legend>Main Video</legend>
<label>Video File</label>
<input id="videoFile" type="file" accept="video/*">
<div class="row">
<div><label>Start (s)</label><input id="startTime" type="number" min="0" step="0.01" value="0"></div>
<div><label>End (s)</label><input id="endTime" type="number" min="0" step="0.01" value="0"></div>
</div>
<div class="sl"><input id="rangeStart" type="range" min="0" max="0" step="0.01" value="0"><input id="rangeEnd" type="range" min="0" max="0" step="0.01" value="0"></div>
<div class="small">Use the sliders to set trim points.</div>
</fieldset>
<fieldset>
<legend>Audio</legend>
<label>Extra Audio (mix or replace)</label>
<input id="audioFile" type="file" accept="audio/*">
<div class="switch">
<label><input id="replaceAudio" type="checkbox">Replace original audio</label>
<label><input id="muteOriginal" type="checkbox">Mute original</label>
</div>
<div class="row">
<div><label>Original Vol</label><input id="volVideo" type="range" min="0" max="1" step="0.01" value="1"></div>
<div><label>Extra Vol</label><input id="volExtra" type="range" min="0" max="1" step="0.01" value="1"></div>
</div>
</fieldset>
<fieldset>
<legend>Overlay</legend>
<div class="row">
<div><label>Image (PNG/JPG)</label><input id="overlayImgFile" type="file" accept="image/*"></div>
<div><label>Video</label><input id="overlayVidFile" type="file" accept="video/*"></div>
</div>
<div class="row">
<div><label>X (%)</label><input id="ovX" type="range" min="0" max="100" step="1" value="5"></div>
<div><label>Y (%)</label><input id="ovY" type="range" min="0" max="100" step="1" value="5"></div>
</div>
<div class="row">
<div><label>Width (%)</label><input id="ovW" type="range" min="5" max="100" step="1" value="30"></div>
<div><label>Opacity</label><input id="ovA" type="range" min="0" max="1" step="0.01" value="1"></div>
</div>
<div class="row">
<div><label>Overlay Start (s)</label><input id="ovStart" type="number" min="0" step="0.01" value="0"></div>
<div><label>Overlay End (s, 0=auto)</label><input id="ovEnd" type="number" min="0" step="0.01" value="0"></div>
</div>
</fieldset>
<fieldset>
<legend>Output</legend>
<div class="row">
<div><label>Resolution</label><select id="res">
<option value="source">Source</option>
<option value="240">240p</option>
<option value="360">360p</option>
<option value="480" selected>480p</option>
<option value="720">720p</option>
<option value="1080">1080p</option>
</select></div>
<div><label>FPS</label><select id="fps">
<option>24</option>
<option selected>30</option>
<option>60</option>
</select></div>
</div>
<div class="row">
<div><label>Quality Preset</label><select id="preset">
<option value="low">Low</option>
<option value="med" selected>Medium</option>
<option value="high">High</option>
<option value="custom">Custom kbps</option>
</select></div>
<div><label>Custom kbps</label><input id="kbps" type="number" min="100" step="50" value="3000"></div>
</div>
<div class="row">
<div><label>Compressor Mode (MB)</label><input id="targetMB" type="number" min="1" step="1" placeholder="e.g. 25"></div>
<div><label>Format</label><select id="fmt"><option value="auto" selected>Auto</option><option value="webm">WEBM</option><option value="mp4">MP4 (Safari)</option></select></div>
</div>
<div class="switch">
<label><input id="keepAlpha" type="checkbox">Keep overlay transparency</label>
<label><input id="livePreview" type="checkbox">Live preview while editing</label>
</div>
</fieldset>
<div class="row">
<button class="btn alt" id="playPreview">Play Preview</button>
<button class="btn" id="exportBtn">Export</button>
<button class="btn alt" id="stopBtn" disabled>Stop</button>
</div>
<div class="meta" id="meta">No video loaded.</div>
</div>
</div>
<div class="panel" style="flex:1.8">
<h2>Preview</h2>
<div class="body">
<div id="previewBox">
<canvas id="canvas"></canvas>
</div>
<div class="tablelike" style="margin-top:10px">
<div class="small mono">Status</div><div class="small mono" id="status">idle</div>
<div class="small mono">Duration</div><div class="small mono" id="dur">0.00s</div>
<div class="small mono">Output Est.</div><div class="small mono" id="est">–</div>
</div>
<hr class="sep">
<div class="output">
<div class="row">
<div>
<video id="resultVideo" controls style="width:100%;max-height:240px;background:#000;border-radius:6px"></video>
</div>
</div>
<div class="row">
<div><a id="downloadLink" class="link" href="#" download style="display:none">Download</a></div>
<div class="small" id="outMeta"></div>
</div>
</div>
</div>
</div>
</div>
<footer>Made for GitHub Pages • Works best in modern browsers • WebM export recommended</footer>

<video id="mainVideo" crossorigin="anonymous" playsinline style="display:none"></video>
<video id="ovVideo" crossorigin="anonymous" playsinline muted style="display:none"></video>
<img id="ovImage" alt="" style="display:none">

<script>
const videoFile=document.getElementById('videoFile')
const audioFile=document.getElementById('audioFile')
const overlayImgFile=document.getElementById('overlayImgFile')
const overlayVidFile=document.getElementById('overlayVidFile')
const mainVideo=document.getElementById('mainVideo')
const ovVideo=document.getElementById('ovVideo')
const ovImage=document.getElementById('ovImage')
const canvas=document.getElementById('canvas')
const ctx=canvas.getContext('2d')
const startTime=document.getElementById('startTime')
const endTime=document.getElementById('endTime')
const rangeStart=document.getElementById('rangeStart')
const rangeEnd=document.getElementById('rangeEnd')
const volVideo=document.getElementById('volVideo')
const volExtra=document.getElementById('volExtra')
const replaceAudio=document.getElementById('replaceAudio')
const muteOriginal=document.getElementById('muteOriginal')
const ovX=document.getElementById('ovX')
const ovY=document.getElementById('ovY')
const ovW=document.getElementById('ovW')
const ovA=document.getElementById('ovA')
const ovStart=document.getElementById('ovStart')
const ovEnd=document.getElementById('ovEnd')
const resSel=document.getElementById('res')
const fpsSel=document.getElementById('fps')
const preset=document.getElementById('preset')
const kbps=document.getElementById('kbps')
const targetMB=document.getElementById('targetMB')
const fmt=document.getElementById('fmt')
const keepAlpha=document.getElementById('keepAlpha')
const livePreview=document.getElementById('livePreview')
const playPreview=document.getElementById('playPreview')
const exportBtn=document.getElementById('exportBtn')
const stopBtn=document.getElementById('stopBtn')
const statusEl=document.getElementById('status')
const durEl=document.getElementById('dur')
const estEl=document.getElementById('est')
const meta=document.getElementById('meta')
const resultVideo=document.getElementById('resultVideo')
const downloadLink=document.getElementById('downloadLink')
const outMeta=document.getElementById('outMeta')

let ready=false
let drawing=false
let recording=false
let rafId=null
let ac=null
let dest=null
let videoSource=null
let extraSource=null
let gainVideo=null
let gainExtra=null
let mediaRecorder=null
let chunks=[]
let canvasStream=null
let mixStream=null
let extraAudioEl=null
let previewing=false

function fmtTime(t){return (Math.max(0,t)||0).toFixed(2)+'s'}
function setStatus(s){statusEl.textContent=s}
function clamp(v,min,max){return Math.min(max,Math.max(min,v))}
function computeOutputSize(){
const sw=mainVideo.videoWidth||640,sh=mainVideo.videoHeight||360,asp=sw/sh||16/9
const sel=resSel.value
if(sel==='source')return {w:sw,h:sh}
const h=parseInt(sel,10)
const w=Math.round(h*asp)
return {w,h}
}
function updateRanges(){
const d=mainVideo.duration||0
rangeStart.max=d
rangeEnd.max=d
rangeStart.value=parseFloat(startTime.value)||0
rangeEnd.value=parseFloat(endTime.value)||d
}
function updateEst(){
const st=parseFloat(startTime.value)||0
const en=parseFloat(endTime.value)||0
const dur=clamp(en-st,0,1e9)
durEl.textContent=dur.toFixed(2)+'s'
let bps=0
if(targetMB.value){
bps=(parseFloat(targetMB.value)*1024*1024*8)/Math.max(0.25,dur)
}else{
const p=preset.value
if(p==='low')bps=1200*1000
if(p==='med')bps=3000*1000
if(p==='high')bps=6000*1000
if(p==='custom')bps=(parseFloat(kbps.value)||3000)*1000
}
const estBytes=(bps*dur)/8
const mb=(estBytes/1024/1024)
estEl.textContent=isFinite(mb)?mb.toFixed(1)+' MB @ '+Math.round(bps/1000)+' kbps':'–'
}
function syncStartEnd(){
let st=parseFloat(startTime.value)||0
let en=parseFloat(endTime.value)||0
const d=mainVideo.duration||0
st=clamp(st,0,d)
en=clamp(en,st,d||st)
startTime.value=st
endTime.value=en
updateRanges()
updateEst()
}
videoFile.addEventListener('change',e=>{
const f=e.target.files&&e.target.files[0]
if(!f)return
const url=URL.createObjectURL(f)
mainVideo.src=url
mainVideo.load()
mainVideo.onloadedmetadata=()=>{
startTime.value=0
endTime.value=mainVideo.duration.toFixed(2)
rangeStart.min=0
rangeEnd.min=0
updateRanges()
const s=computeOutputSize()
canvas.width=s.w
canvas.height=s.h
meta.textContent='Loaded '+f.name+' • '+mainVideo.videoWidth+'x'+mainVideo.videoHeight+' • '+fmtTime(mainVideo.duration)
ready=true
updateEst()
if(livePreview.checked)startPreview()
}
})
overlayImgFile.addEventListener('change',e=>{
const f=e.target.files&&e.target.files[0]
if(!f){ovImage.src='';ovImage.style.display='none';return}
const url=URL.createObjectURL(f)
ovImage.onload=()=>{ovImage.style.display='block';if(livePreview.checked)startPreview()}
ovImage.src=url
})
overlayVidFile.addEventListener('change',e=>{
const f=e.target.files&&e.target.files[0]
if(!f){ovVideo.removeAttribute('src');return}
const url=URL.createObjectURL(f)
ovVideo.src=url
ovVideo.load()
ovVideo.onloadedmetadata=()=>{if(livePreview.checked)startPreview()}
})
audioFile.addEventListener('change',e=>{
if(livePreview.checked)startPreview()
})

startTime.addEventListener('input',syncStartEnd)
endTime.addEventListener('input',syncStartEnd)
rangeStart.addEventListener('input',e=>{startTime.value=e.target.value;syncStartEnd()})
rangeEnd.addEventListener('input',e=>{endTime.value=e.target.value;syncStartEnd()})
;[ovX,ovY,ovW,ovA,ovStart,ovEnd,resSel,fpsSel,preset,kbps,targetMB,keepAlpha,livePreview,replaceAudio,muteOriginal,volVideo,volExtra].forEach(el=>el.addEventListener('input',()=>{
if(resSel===el&&ready){const s=computeOutputSize();canvas.width=s.w;canvas.height=s.h}
updateEst()
if(livePreview.checked)startPreview()
}))

function drawFrame(){
if(!previewing&&!recording){drawing=false;return}
const s=computeOutputSize()
if(canvas.width!==s.w||canvas.height!==s.h){canvas.width=s.w;canvas.height=s.h}
ctx.clearRect(0,0,canvas.width,canvas.height)
if(mainVideo.readyState>=2){
ctx.globalAlpha=1
ctx.drawImage(mainVideo,0,0,canvas.width,canvas.height)
}
const now=mainVideo.currentTime||0
const ost=parseFloat(ovStart.value)||0
let oen=parseFloat(ovEnd.value)||0
if(oen<=0)oen=1e9
if(ovImage.src&&ovImage.complete&&now>=ost&&now<=oen){
const wPct=parseFloat(ovW.value)/100
const w=Math.round(canvas.width*wPct)
const h=Math.round(ovImage.naturalHeight*(w/ovImage.naturalWidth))
const x=Math.round(canvas.width*(parseFloat(ovX.value)/100))
const y=Math.round(canvas.height*(parseFloat(ovY.value)/100))
ctx.globalAlpha=parseFloat(ovA.value)
ctx.drawImage(ovImage,x,y,w,h)
ctx.globalAlpha=1
}
if(ovVideo.src&&ovVideo.readyState>=2&&now>=ost&&now<=oen){
const offset=now-ost
if(Math.abs((ovVideo.currentTime||0)-offset)>0.05)ovVideo.currentTime=clamp(offset,0,ovVideo.duration||offset)
if(ovVideo.paused&&!recording&&previewing)ovVideo.play().catch(()=>{})
if(recording&&!ovVideo.paused){} 
const wPct=parseFloat(ovW.value)/100
const w=Math.round(canvas.width*wPct)
const h=Math.round(ovVideo.videoHeight*(w/ovVideo.videoWidth))
const x=Math.round(canvas.width*(parseFloat(ovX.value)/100))
const y=Math.round(canvas.height*(parseFloat(ovY.value)/100))
ctx.globalAlpha=parseFloat(ovA.value)
ctx.drawImage(ovVideo,x,y,w,h)
ctx.globalAlpha=1
}
rafId=requestAnimationFrame(drawFrame)
}

function startPreview(){
if(!ready)return
previewing=true
mainVideo.muted=true
mainVideo.currentTime=parseFloat(startTime.value)||0
mainVideo.playbackRate=1
ovVideo.muted=true
mainVideo.play().then(()=>{}).catch(()=>{})
if(!drawing){drawing=true;drawFrame()}
setStatus('previewing')
}
function stopPreview(){
previewing=false
mainVideo.pause()
if(!recording){ctx.clearRect(0,0,canvas.width,canvas.height)}
setStatus('idle')
}

playPreview.addEventListener('click',()=>{
if(!previewing)startPreview();else stopPreview()
})

async function setupAudioMix(){
if(ac)ac.close()
ac=new (window.AudioContext||window.webkitAudioContext)()
dest=ac.createMediaStreamDestination()
gainVideo=ac.createGain()
gainExtra=ac.createGain()
gainVideo.gain.value=muteOriginal.checked?0:parseFloat(volVideo.value||1)
gainExtra.gain.value=parseFloat(volExtra.value||1)
videoSource=ac.createMediaElementSource(mainVideo)
videoSource.connect(gainVideo).connect(dest)
if(audioFile.files&&audioFile.files[0]){
if(extraAudioEl)extraAudioEl.pause()
extraAudioEl=new Audio()
extraAudioEl.crossOrigin='anonymous'
extraAudioEl.src=URL.createObjectURL(audioFile.files[0])
extraAudioEl.loop=false
extraAudioEl.preload='auto'
extraAudioEl.oncanplay=()=>{}
extraSource=ac.createMediaElementSource(extraAudioEl)
if(replaceAudio.checked){
gainVideo.disconnect()
gainExtra.connect(dest)
}else{
gainExtra.connect(dest)
}
}else{
extraSource=null
if(replaceAudio.checked){gainVideo.disconnect();gainExtra.disconnect()}
}
}

function selectMime(){
if(fmt.value==='webm'){
if(MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus'))return {type:'video/webm;codecs=vp9,opus',ext:'webm'}
if(MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus'))return {type:'video/webm;codecs=vp8,opus',ext:'webm'}
return {type:'video/webm',ext:'webm'}
}
if(fmt.value==='mp4'){
if(MediaRecorder.isTypeSupported('video/mp4;codecs=h264,aac'))return {type:'video/mp4;codecs=h264,aac',ext:'mp4'}
if(MediaRecorder.isTypeSupported('video/mp4'))return {type:'video/mp4',ext:'mp4'}
}
if(MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus'))return {type:'video/webm;codecs=vp9,opus',ext:'webm'}
if(MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus'))return {type:'video/webm;codecs=vp8,opus',ext:'webm'}
if(MediaRecorder.isTypeSupported('video/mp4;codecs=h264,aac'))return {type:'video/mp4;codecs=h264,aac',ext:'mp4'}
return {type:'video/webm',ext:'webm'}
}

function computeBitrate(){
const st=parseFloat(startTime.value)||0
const en=parseFloat(endTime.value)||0
const dur=Math.max(0.25,en-st)
if(targetMB.value){
const total=(parseFloat(targetMB.value)*1024*1024*8)/dur
return Math.max(120000,total|0)
}else{
const p=preset.value
if(p==='low')return 1200*1000
if(p==='med')return 3000*1000
if(p==='high')return 6000*1000
if(p==='custom')return Math.max(100000,(parseFloat(kbps.value)||3000)*1000)
}
return 3000*1000
}

function calcCanvasStream(){
const fps=parseInt(fpsSel.value,10)||30
return canvas.captureStream(fps)
}

function handleStop(blob,ext){
const url=URL.createObjectURL(blob)
resultVideo.src=url
resultVideo.load()
resultVideo.play().catch(()=>{})
downloadLink.href=url
downloadLink.download='edit-'+Date.now()+'.'+ext
downloadLink.style.display='inline-block'
outMeta.textContent=(blob.size/1024/1024).toFixed(2)+' MB • '+ext.toUpperCase()
setStatus('done')
stopBtn.disabled=true
exportBtn.disabled=false
playPreview.disabled=false
}

function tickStopAt(endAt){
const onTime=()=>{if((mainVideo.currentTime||0)>=endAt-0.01){stopRecording()}}
mainVideo.addEventListener('timeupdate',onTime,{once:false})
return ()=>mainVideo.removeEventListener('timeupdate',onTime)
}

async function startRecording(){
if(!ready)return
exportBtn.disabled=true
stopBtn.disabled=false
playPreview.disabled=true
await setupAudioMix()
const {w,h}=computeOutputSize()
if(w<=0||h<=0)return
canvas.width=w;canvas.height=h
const st=parseFloat(startTime.value)||0
const en=parseFloat(endTime.value)||0
const endAt=Math.max(st,en)
const bps=computeBitrate()
const mime=selectMime()
const fps=parseInt(fpsSel.value,10)||30
canvasStream=calcCanvasStream()
if(dest&&dest.stream){
const tracks=[...canvasStream.getVideoTracks()]
if(dest.stream.getAudioTracks().length>0)tracks.push(dest.stream.getAudioTracks()[0])
mixStream=new MediaStream(tracks)
}else{
mixStream=canvasStream
}
chunks=[]
mediaRecorder=new MediaRecorder(mixStream,{mimeType:mime.type,bitsPerSecond:bps,videoBitsPerSecond:bps*0.85,audioBitsPerSecond:bps*0.15})
mediaRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0)chunks.push(e.data)}
mediaRecorder.onstop=()=>{const blob=new Blob(chunks,{type:mime.type});handleStop(blob,mime.ext);recording=false;stopPreview()}
recording=true
setStatus('encoding')
mainVideo.muted=true
mainVideo.currentTime=st
mainVideo.playbackRate=1
if(extraAudioEl){
try{extraAudioEl.currentTime=0}catch(e){}
if(replaceAudio.checked||!muteOriginal.checked){} 
extraAudioEl.play().catch(()=>{})
}
if(ovVideo.src){ovVideo.muted=true}
mainVideo.play().then(()=>{}).catch(()=>{})
if(!drawing){drawing=true;drawFrame()}
mediaRecorder.start(250)
const unbind=tickStopAt(endAt)
stopBtn.onclick=()=>{unbind();stopRecording()}
}
function stopRecording(){
try{mediaRecorder.stop()}catch(e){}
recording=false
stopBtn.disabled=true
setStatus('finalizing')
mainVideo.pause()
if(extraAudioEl)extraAudioEl.pause()
}

exportBtn.addEventListener('click',startRecording)

document.addEventListener('visibilitychange',()=>{
if(document.hidden&&previewing){stopPreview()}
})

window.addEventListener('keydown',e=>{
if(e.code==='Space'){e.preventDefault();if(recording){stopRecording()}else if(previewing){stopPreview()}else{startPreview()}}
if(e.key==='['){startTime.value=Math.max(0,(parseFloat(startTime.value)||0)-0.5).toFixed(2);syncStartEnd()}
if(e.key===']'){endTime.value=((parseFloat(endTime.value)||0)+0.5).toFixed(2);syncStartEnd()}
})

setInterval(()=>{updateEst()},500)
</script>
</body>
</html>
